#!/usr/bin/env ruby

require 'pathname'
$baseDir = Pathname.new(File.dirname(__FILE__) + '/..').realpath

require "#{$baseDir}/lib/uberblog"
require 'data_mapper'
require 'sinatra'
require "sinatra/json"
require 'json'

$logger  = Uberblog::Logger.new($stdout, $stderr)

DataMapper::Logger.new($logger.stdout, :debug)
DataMapper.setup(:default, "sqlite://#{$baseDir}/data/database.sqlite")
DataMapper::Model.raise_on_save_failure = true

require 'uberblog/model/rating'

DataMapper.finalize

def raise_error(code, message)
  halt json :error_code => code, :error_message => message
end

not_found do
  "Nothing here.\n"
end

get '/' do
  "/rating\n"
end

get '/rating/' do
  uris = ''
  Uberblog::Model::Rating.all.each { |rating| uris << "/rating/#{rating.post}\n" }
  uris
end

get '/rating/:post' do
  rating = Uberblog::Model::Rating.get(params[:post])
  halt 404 if rating.nil?
  json rating.get_attributes
end

put '/rating/:post' do
  body   = request.body.read

  raise_error 400, "Empty request body! Expects JSON like '{rate: 5}'." if body.size == 0 or body.nil?

  begin
    data   = JSON.parse body
  rescue
    raise_error 500, "Can't parse JSON! Given request body was '#{body}'."
  end

  rating = Uberblog::Model::Rating.first_or_create({ :post => params[:post] })

  raise_error 400, "Expected JSON key 'rate(Integer)' not present!." if data['rate'].nil?
  rating.add(data['rate'].to_i)
  $logger.log("Saving rate with: #{data['rate'].to_i}")

  begin
    rating.save
  rescue
    $logger.error $!
    raise_error 500, "Can't save entity! Exception was: #{$!}"
  end

  json rating.get_attributes
end