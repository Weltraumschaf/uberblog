#!/usr/bin/env ruby

require 'pathname'
$baseDir = Pathname.new(File.dirname(__FILE__) + '/..').realpath

require "#{$baseDir}/lib/uberblog"
require 'data_mapper'
require 'sinatra'
require "sinatra/json"
require 'json'

DataMapper::Logger.new($stdout, :debug)
DataMapper.setup(:default, "sqlite://#{$baseDir}/data/database.sqlite")
DataMapper::Model.raise_on_save_failure = true
require 'uberblog/model'
DataMapper.finalize

def raise_error(code, message)
  halt json :error_code => code, :error_message => message
end

def to_json(rating)
  json :post => rating.post, :sum => rating.sum, :count => rating.count, :average => rating.average
end

not_found do
  "Nothing here.\n"
end

get '/' do
  "/rating\n"
end

get '/rating' do
  redirect '/rating/', 303
end

get '/rating/' do
  uris = ''
  Uberblog::Model::Rating.all.each { |rating| uris << "/rating/#{rating.post}\n" }
  uris
end

get '/rating/:post' do
  rating = Uberblog::Model::Rating.get(params[:post])
  halt 404 if rating.nil?
  json :post => rating.post, :sum => rating.sum, :count => rating.count, :average => rating.average
end

put '/rating/:post' do
  body   = request.body.read

  raise_error 400, "Empty request body! Expects JSON like '{rate: 5}'." if body.size == 0 or body.nil?

  begin
    data   = JSON.parse body
  rescue
    raise_error 500, "Can't parse JSON! Given request body was '#{body}'."
  end

  rating = Uberblog::Model::Rating.first_or_create({ :post => params[:post] })

  raise_error 400, "Expected JSON key 'rate(Integer)' not present!." if data['rate'].nil?

  rating.attributes = {
    :sum   => rating.sum + data['rate'].to_i,
    :count => rating.count + 1
  }
  rating.save

  to_json rating
end